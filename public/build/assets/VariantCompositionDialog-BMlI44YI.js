import{d as ge,r as _,aw as _e,V as ae,w as ye,g as v,f as l,o as n,b as t,e as s,s as d,X as w,t as o,a0 as h,l as y,c as x,m as q,$ as ke,p as Ve,ay as be,F as H,i as te,az as he,av as D,b8 as xe}from"./main-BDjA8ZE0.js";import{f as $}from"./helpers-B-vn2Qqf.js";import{D as Ce}from"./DeleteConfirmationDialog-DIkwJ7SA.js";import{V as we}from"./VDialog-kKqt15qI.js";import{V as B,b as M,c as Ie}from"./VCard-Af9i-cHC.js";import{V as S}from"./VDivider-CNJRCtTw.js";import{V as z}from"./VCardText-pusdEz6_.js";import{V as ie}from"./VAlert-BUxPj0YW.js";import{V as qe}from"./VForm-D-6FADkt.js";import{V as De,a as R}from"./VRow-B_tm1uSD.js";import{V as $e}from"./VAutocomplete-X1kKS8Y9.js";import{a as le,V as ze,b as Te,d as Pe}from"./VList-BUBOvLR6.js";import{V as se}from"./VAvatar-BJUFvcQH.js";import{V as oe}from"./VImg-DavVY8Sw.js";import{V as ne}from"./VTextField-BQMuFhOa.js";import{V as P}from"./VChip-DmPw7oBU.js";import{V as Ke}from"./VSpacer-P6zft6lJ.js";import{_ as Be}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./VOverlay-DpeqFwNJ.js";import"./forwardRefs-B931MWyl.js";/* empty css              */import"./VSelect-CqUH4kv5.js";import"./VMenu-BN6MK1Ni.js";import"./VCheckboxBtn-Ml9VaORK.js";import"./filter-BTEElEgT.js";const Me={class:"d-flex align-center justify-space-between"},Se={class:"d-flex align-center"},Fe={class:"d-flex justify-between align-center"},Ue={class:"text-end"},je={class:"text-h6"},Ae={key:0},Le={class:"d-flex align-center"},Ne={class:"d-flex align-center me-4"},Ee={class:"text-end me-4",style:{"min-width":"120px"}},Ge={class:"font-weight-medium"},Je={class:"text-caption text-medium-emphasis"},He={class:"d-flex justify-between align-center"},Re={class:"text-body-2 text-medium-emphasis"},Oe={class:"text-end"},Xe={class:"text-h5 font-weight-bold"},Qe={key:0,class:"text-body-2"},We={key:0},Ye={class:"d-flex justify-between align-center"},Ze={key:0},ea={key:0,class:"mt-3"},aa=ge({__name:"VariantCompositionDialog",props:{modelValue:{type:Boolean},variant:{}},emits:["update:modelValue","save"],setup(re,{emit:de}){const V=re,O=de,F=_(!1),U=_(!1),j=_(!1),ue=_(!1),A=_(!1),L=_(),r=_([]),N=_([]),f=_(null),K=_(!1),I=_(null),C=(i,e="success")=>{console.log(`${e.toUpperCase()}: ${i}`)},c=_e({item_id:null,quantity:1}),E=ae({get:()=>V.modelValue,set:i=>O("update:modelValue",i)}),T=ae(()=>r.value.reduce((i,e)=>i+e.total_cost,0)),X=async()=>{var i;if((i=V.variant)!=null&&i.id){F.value=!0;try{const e=await D.get(`/api/variant-items/variant/${V.variant.id}`);r.value=e.data}catch(e){console.error("Error loading composition:",e),r.value=[]}finally{F.value=!1}}},me=async()=>{U.value=!0;try{const i=await D.get("/api/items",{params:{per_page:-1,status:!0,type:"raw_material"}});N.value=i.data.data||i.data}catch(i){console.error("Error loading items:",i),N.value=[]}finally{U.value=!1}},Q=async()=>{var e,m,u;const{valid:i}=await L.value.validate();if(!(!i||!((e=V.variant)!=null&&e.id))){j.value=!0;try{const p={variant_id:V.variant.id,item_id:c.item_id,quantity:c.quantity},a=await D.post("/api/variant-items",p);r.value.push(a.data),c.item_id=null,c.quantity=1,L.value.resetValidation(),C("Item berhasil ditambahkan ke komposisi")}catch(p){const a=((u=(m=p.response)==null?void 0:m.data)==null?void 0:u.message)||"Gagal menambahkan item";C(a,"error")}finally{j.value=!1}}},W=(i,e)=>{e>0&&(i.quantity=e,G(i))},G=async i=>{var e,m;try{const u=await D.put(`/api/variant-items/${i.id}`,{quantity:i.quantity});Object.assign(i,u.data),C("Jumlah berhasil diupdate")}catch(u){const p=((m=(e=u.response)==null?void 0:e.data)==null?void 0:m.message)||"Gagal mengupdate item";C(p,"error"),X()}},ce=async i=>{I.value=i,K.value=!0},pe=async()=>{var e,m;if(!I.value)return;const i=I.value;i.removing=!0;try{await D.delete(`/api/variant-items/${i.id}`);const u=r.value.findIndex(p=>p.id===i.id);u>-1&&r.value.splice(u,1),C("Item berhasil dihapus dari komposisi")}catch(u){const p=((m=(e=u.response)==null?void 0:e.data)==null?void 0:m.message)||"Gagal menghapus item";C(p,"error")}finally{i.removing=!1,K.value=!1,I.value=null}},ve=async()=>{var i;if((i=V.variant)!=null&&i.id){A.value=!0;try{const e=await D.get(`/api/variants/${V.variant.id}/production-capacity`);f.value=e.data}catch(e){console.error("Error checking production capacity:",e),C("Gagal mengecek kapasitas produksi","error")}finally{A.value=!1}}},fe=()=>{O("save"),J()},J=()=>{E.value=!1,xe(()=>{r.value=[],f.value=null,c.item_id=null,c.quantity=1})};return ye(()=>V.modelValue,i=>{i&&V.variant&&(X(),me())}),(i,e)=>(n(),v(we,{modelValue:E.value,"onUpdate:modelValue":e[3]||(e[3]=m=>E.value=m),"max-width":"1200px",persistent:""},{default:l(()=>{var m,u,p;return[t(B,null,{default:l(()=>[t(M,{class:"text-h5"},{default:l(()=>{var a;return[s("div",Me,[s("div",Se,[t(w,{icon:"mdi-puzzle",class:"me-2"}),d(" Komposisi Variant: "+o((a=i.variant)==null?void 0:a.name),1)]),t(h,{icon:"mdi-close",variant:"text",onClick:J})])]}),_:1}),t(S),t(z,{class:"pt-4"},{default:l(()=>[i.variant?(n(),v(ie,{key:0,type:"info",variant:"tonal",class:"mb-4"},{default:l(()=>{var a;return[s("div",Fe,[s("div",null,[s("strong",null,o(i.variant.name),1),d(" ("+o(i.variant.sku)+") ",1),e[4]||(e[4]=s("br",null,null,-1)),s("small",null,"Produk: "+o((a=i.variant.product)==null?void 0:a.name),1)]),s("div",Ue,[s("div",je,o(q($)(i.variant.price)),1),T.value>0?(n(),x("small",Ae," HPP: "+o(q($)(T.value))+" (Margin: "+o(((i.variant.price-T.value)/i.variant.price*100).toFixed(1))+"%) ",1)):y("",!0)])])]}),_:1})):y("",!0),t(B,{variant:"outlined",class:"mb-4"},{default:l(()=>[t(M,{class:"text-h6"},{default:l(()=>e[5]||(e[5]=[d("Tambah Item Komposisi")])),_:1,__:[5]}),t(z,null,{default:l(()=>[t(qe,{ref_key:"addForm",ref:L,onSubmit:ke(Q,["prevent"])},{default:l(()=>[t(De,null,{default:l(()=>[t(R,{cols:"12",md:"6"},{default:l(()=>[t($e,{modelValue:c.item_id,"onUpdate:modelValue":e[0]||(e[0]=a=>c.item_id=a),items:N.value,loading:U.value,label:"Pilih Item *",variant:"outlined","item-title":"name","item-value":"id",rules:[a=>!!a||"Item harus dipilih"],clearable:""},{item:l(({props:a,item:k})=>[t(le,Ve(a,{subtitle:`${k.raw.code} | Stok: ${k.raw.current_stock} | ${q($)(k.raw.cost)}`}),{prepend:l(()=>[t(se,{size:"40"},{default:l(()=>[t(oe,{src:k.raw.image||"/images/default-item.png"},null,8,["src"])]),_:2},1024)]),_:2},1040,["subtitle"])]),_:1},8,["modelValue","items","loading","rules"])]),_:1}),t(R,{cols:"12",md:"3"},{default:l(()=>[t(ne,{modelValue:c.quantity,"onUpdate:modelValue":e[1]||(e[1]=a=>c.quantity=a),modelModifiers:{number:!0},label:"Jumlah *",variant:"outlined",type:"number",min:"0.01",step:"0.01",rules:[a=>a>0||"Jumlah harus lebih dari 0"]},null,8,["modelValue","rules"])]),_:1}),t(R,{cols:"12",md:"3"},{default:l(()=>[t(h,{color:"primary",onClick:Q,disabled:!c.item_id||!c.quantity,loading:j.value,block:"",size:"large"},{default:l(()=>[t(w,{icon:"mdi-plus",class:"me-1"}),e[6]||(e[6]=d(" Tambah "))]),_:1,__:[6]},8,["disabled","loading"])]),_:1})]),_:1})]),_:1},512)]),_:1})]),_:1}),t(B,{variant:"outlined"},{default:l(()=>[t(M,{class:"d-flex justify-between align-center"},{default:l(()=>[e[7]||(e[7]=s("span",{class:"text-h6"},"Daftar Komposisi",-1)),t(P,{color:"primary",variant:"elevated"},{default:l(()=>[d(o(r.value.length)+" Item ",1)]),_:1})]),_:1,__:[7]}),F.value?(n(),v(z,{key:0,class:"text-center py-8"},{default:l(()=>[t(be,{indeterminate:""}),e[8]||(e[8]=s("div",{class:"mt-2"},"Memuat komposisi...",-1))]),_:1,__:[8]})):r.value.length===0?(n(),v(z,{key:1,class:"text-center py-8"},{default:l(()=>[t(w,{icon:"mdi-package-variant-closed",size:"64",class:"text-medium-emphasis mb-2"}),e[9]||(e[9]=s("div",{class:"text-h6 text-medium-emphasis"},"Belum ada komposisi",-1)),e[10]||(e[10]=s("div",{class:"text-body-2 text-medium-emphasis"}," Tambahkan item untuk membuat komposisi variant ",-1))]),_:1,__:[9,10]})):(n(),v(ze,{key:2},{default:l(()=>[(n(!0),x(H,null,te(r.value,(a,k)=>(n(),x(H,{key:a.id},[t(le,null,{prepend:l(()=>[t(se,{size:"48"},{default:l(()=>{var g;return[t(oe,{src:((g=a.item)==null?void 0:g.image)||"/images/default-item.png"},null,8,["src"])]}),_:2},1024)]),append:l(()=>{var g;return[s("div",Le,[s("div",Ne,[t(h,{icon:"mdi-minus",size:"small",variant:"text",onClick:b=>W(a,a.quantity-.5),disabled:a.quantity<=.5},null,8,["onClick","disabled"]),t(ne,{modelValue:a.quantity,"onUpdate:modelValue":b=>a.quantity=b,modelModifiers:{number:!0},variant:"outlined",density:"compact",type:"number",min:"0.01",step:"0.01",style:{width:"100px"},onBlur:b=>G(a),onKeydown:he(b=>G(a),["enter"])},null,8,["modelValue","onUpdate:modelValue","onBlur","onKeydown"]),t(h,{icon:"mdi-plus",size:"small",variant:"text",onClick:b=>W(a,a.quantity+.5)},null,8,["onClick"])]),s("div",Ee,[s("div",Ge,o(q($)(a.total_cost)),1),s("div",Je,o(a.quantity)+" "+o((g=a.item)==null?void 0:g.unit),1)]),t(h,{icon:"mdi-delete",size:"small",variant:"text",color:"error",onClick:b=>ce(a),loading:a.removing},null,8,["onClick","loading"])])]}),default:l(()=>[t(Te,null,{default:l(()=>{var g;return[d(o((g=a.item)==null?void 0:g.name)+" ",1),a.stock_status==="critical"?(n(),v(P,{key:0,color:"error",size:"x-small",class:"ml-2"},{default:l(()=>e[11]||(e[11]=[d(" Stok Kritis ")])),_:1,__:[11]})):a.stock_status==="low"?(n(),v(P,{key:1,color:"warning",size:"x-small",class:"ml-2"},{default:l(()=>e[12]||(e[12]=[d(" Stok Rendah ")])),_:1,__:[12]})):y("",!0)]}),_:2},1024),t(Pe,null,{default:l(()=>{var g,b,Y,Z,ee;return[d(o((g=a.item)==null?void 0:g.code)+" | Stok: "+o((b=a.item)==null?void 0:b.current_stock)+" "+o((Y=a.item)==null?void 0:Y.unit)+" | "+o(q($)(((Z=a.item)==null?void 0:Z.cost)||0))+"/"+o((ee=a.item)==null?void 0:ee.unit),1)]}),_:2},1024)]),_:2},1024),k<r.value.length-1?(n(),v(S,{key:0})):y("",!0)],64))),128))]),_:1})),r.value.length>0?(n(),v(S,{key:3})):y("",!0),r.value.length>0?(n(),v(z,{key:4},{default:l(()=>{var a;return[s("div",He,[s("div",null,[e[13]||(e[13]=s("div",{class:"text-h6"},"Total HPP Komposisi",-1)),s("div",Re,o(r.value.length)+" item komposisi ",1)]),s("div",Oe,[s("div",Xe,o(q($)(T.value)),1),(a=i.variant)!=null&&a.price?(n(),x("div",Qe," Margin: "+o(((i.variant.price-T.value)/i.variant.price*100).toFixed(1))+"% ",1)):y("",!0)])])]}),_:1})):y("",!0)]),_:1}),r.value.length>0?(n(),v(B,{key:1,variant:"outlined",class:"mt-4"},{default:l(()=>[t(M,{class:"text-h6"},{default:l(()=>[t(w,{icon:"mdi-factory",class:"me-2"}),e[14]||(e[14]=d(" Kapasitas Produksi "))]),_:1,__:[14]}),t(z,null,{default:l(()=>{var a;return[t(h,{onClick:ve,loading:A.value,color:"info",variant:"outlined",class:"mb-3"},{default:l(()=>[t(w,{icon:"mdi-calculator",class:"me-1"}),e[15]||(e[15]=d(" Cek Kapasitas Produksi "))]),_:1,__:[15]},8,["loading"]),f.value?(n(),x("div",We,[t(ie,{type:f.value.can_produce>0?"success":"error",variant:"tonal"},{default:l(()=>[s("div",Ye,[s("div",null,[s("strong",null,o(f.value.can_produce>0?"Dapat Memproduksi":"Tidak Dapat Memproduksi"),1),f.value.can_produce>0?(n(),x("div",Ze," Maksimal "+o(f.value.can_produce)+" unit variant ",1)):y("",!0)]),t(P,{color:f.value.can_produce>0?"success":"error",variant:"elevated"},{default:l(()=>[d(o(f.value.can_produce)+" Unit ",1)]),_:1},8,["color"])])]),_:1},8,["type"]),((a=f.value.limiting_items)==null?void 0:a.length)>0?(n(),x("div",ea,[e[16]||(e[16]=s("h4",{class:"text-subtitle-1 mb-2"},"Item Pembatas:",-1)),(n(!0),x(H,null,te(f.value.limiting_items,k=>(n(),v(P,{key:k.item_id,color:"warning",class:"me-2 mb-1",size:"small"},{default:l(()=>[d(o(k.name)+": "+o(k.available)+" tersedia ",1)]),_:2},1024))),128))])):y("",!0)])):y("",!0)]}),_:1})]),_:1})):y("",!0)]),_:1}),t(S),t(Ie,null,{default:l(()=>[t(Ke),t(h,{color:"grey-darken-1",variant:"outlined",onClick:J},{default:l(()=>[t(w,{icon:"mdi-close",class:"me-1"}),e[17]||(e[17]=d(" Tutup "))]),_:1,__:[17]}),t(h,{color:"primary",variant:"elevated",onClick:fe,loading:ue.value},{default:l(()=>[t(w,{icon:"mdi-content-save",class:"me-1"}),e[18]||(e[18]=d(" Simpan Komposisi "))]),_:1,__:[18]},8,["loading"])]),_:1})]),_:1}),t(Ce,{modelValue:K.value,"onUpdate:modelValue":e[2]||(e[2]=a=>K.value=a),"item-name":((u=(m=I.value)==null?void 0:m.item)==null?void 0:u.name)||"",loading:((p=I.value)==null?void 0:p.removing)||!1,onConfirm:pe},null,8,["modelValue","item-name","loading"])]}),_:1},8,["modelValue"]))}}),qa=Be(aa,[["__scopeId","data-v-709e9234"]]);export{qa as default};
