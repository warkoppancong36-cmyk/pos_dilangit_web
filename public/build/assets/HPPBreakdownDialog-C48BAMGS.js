import{r as h,V as q,aA as T,a3 as ae,d as oe,w as ee,c as X,F as le,b as a,f as t,e as n,X as A,t as u,a0 as I,g as x,l as C,m as s,s as P,aw as se,b9 as re,o as y}from"./main-JzQIkBR4.js";import{$ as ne}from"./api-Bjw0ITcB.js";import{V as ie}from"./VDialog-CnInoHBg.js";import{V as te}from"./VSnackbar-oqMQ5bec.js";import{V as U,b as Y,c as de}from"./VCard-Cm2ybfyl.js";import{V as M}from"./VCardText-N9WsQ_Cb.js";import{V as z,a as b}from"./VRow-D-i4BTmq.js";import{V as ue}from"./VSelect-BgLsoWpZ.js";import{V as ce}from"./VDataTable-KoTVohsx.js";import{V as pe}from"./VDivider-CjU0MPRf.js";import{V as K}from"./VChip-Dr-hGTp_.js";import{V as me}from"./VTextField-NL4CS3vX.js";import{V as fe}from"./VAlert-DKI5KgRB.js";import{V as ve}from"./VSpacer-rbIEEdgT.js";import{_ as ge}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Pe=()=>{const f=h(!1),E=h(null),v=h(null),$=h(null),H=h(null),i=h([]),S=async()=>{f.value=!0;try{const l=(await T.get("/api/hpp/dashboard")).data;if(l.success)return H.value=l.data,l.data;throw new Error(l.message||"Failed to get HPP dashboard")}catch(d){throw console.error("Error getting HPP dashboard:",d),d}finally{f.value=!1}},Q=async(d,l="current")=>{f.value=!0;try{console.log("🔍 HPP Breakdown - Product ID:",d,"Method:",l),console.log("🔍 Access Token:",ae("accessToken").value?"EXISTS":"NOT FOUND");const k=(await T.get(`/api/hpp/products/${d}/breakdown?method=${l}`)).data;if(k.success)return E.value=k.data.hpp_breakdown,k.data;throw new Error(k.message||"Failed to get HPP breakdown")}catch(r){throw console.error("❌ Error getting HPP breakdown:",r),r}finally{f.value=!1}},G=async(d,l)=>{f.value=!0;try{console.log("🔄 Updating HPP for product:",d,"with method:",l);const r=localStorage.getItem("token"),_=(await T.post(`/api/hpp/products/${d}/update`,{method:l},{headers:{Authorization:`Bearer ${r}`,Accept:"application/json","Content-Type":"application/json"}})).data;if(_.success)return console.log(`✅ HPP updated successfully for ${_.data.product_name}`),_.data;throw new Error(_.message||"Failed to update HPP")}catch(r){throw console.error("❌ Error updating HPP:",r),r}finally{f.value=!1}},J=async d=>{f.value=!0;try{const r=(await T.get(`/api/hpp/products/${d}/compare-methods`)).data;if(r.success)return v.value=r.data,r.data;throw new Error(r.message||"Failed to compare HPP methods")}catch(l){throw console.error("Error comparing HPP methods:",l),l}finally{f.value=!1}},w=async(d,l)=>{f.value=!0;try{console.log("🔄 Calculating suggested price for product:",d,"with markup:",l);const r=localStorage.getItem("token"),_=(await T.post(`/api/hpp/products/${d}/suggested-price`,{markup_percentage:l},{headers:{Authorization:`Bearer ${r}`,Accept:"application/json","Content-Type":"application/json"}})).data;if(_.success)return $.value=_.data,console.log("✅ Suggested price calculated:",_.data),_.data;throw new Error(_.message||"Failed to calculate suggested price")}catch(r){throw console.error("❌ Error calculating suggested price:",r),r}finally{f.value=!1}},V=async(d,l,r,k=!0,_=!1)=>{f.value=!0;try{console.log("🔄 Updating price from HPP for product:",d);const c=localStorage.getItem("token"),e={method:l,update_cost:k};_?(e.target_price=r,console.log("📊 Using target price mode:",r)):(e.markup_percentage=r,console.log("📊 Using markup percentage mode:",r));const p=(await T.post(`/api/hpp/products/${d}/update-price`,e,{headers:{Authorization:`Bearer ${c}`,Accept:"application/json","Content-Type":"application/json"}})).data;if(p.success)return console.log(`✅ Price updated successfully for ${p.data.product_name}`),p;throw new Error(p.message||"Failed to update price from HPP")}catch(c){throw console.error("❌ Error updating price from HPP:",c),c}finally{f.value=!1}},j=async d=>{f.value=!0;try{const l=await ne("/hpp/bulk-update",{method:"POST",body:{method:d}});if(l.success)return i.value=l.data.details,console.log(`Bulk HPP update completed for ${l.data.updated_products} products`),l.data;throw new Error(l.message||"Failed to bulk update HPP")}catch(l){throw console.error("Error bulk updating HPP:",l),l}finally{f.value=!1}},m=q(()=>E.value!==null),N=q(()=>v.value!==null),B=q(()=>$.value!==null),D=q(()=>H.value!==null);return{loading:f,currentHPPBreakdown:E,currentHPPComparison:v,currentHPPSuggestion:$,hppDashboard:H,bulkUpdateResults:i,getHPPDashboard:S,getProductHPPBreakdown:Q,updateProductHPP:G,compareHPPMethods:J,calculateSuggestedPrice:w,updatePriceFromHPP:V,bulkUpdateHPP:j,hasHPPData:m,hasComparisonData:N,hasSuggestionData:B,hasDashboardData:D,formatCurrency:d=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(d),calculateProfitPercentage:(d,l)=>l===0?0:(d-l)/l*100,resetStates:()=>{E.value=null,v.value=null,$.value=null,i.value=[]}}},_e={class:"d-flex align-center gap-3"},he={class:"text-h5 font-weight-bold"},ye={class:"text-h6"},we={class:"text-body-1"},ke={class:"d-flex flex-column"},be={class:"font-weight-medium"},Ve={class:"text-caption text-grey-darken-1"},He={class:"font-weight-medium"},xe={key:0,class:"text-caption"},Ce={key:1,class:"text-grey-lighten-1 text-caption"},$e={class:"v-data-table__footer"},Se={class:"pa-4 d-flex justify-space-between align-center"},Be={class:"text-subtitle-1 font-weight-bold"},De={key:0,class:"text-center"},Ie={class:"text-h6 font-weight-bold text-success"},Te={class:"text-caption text-grey-darken-1"},Ee={class:"d-flex justify-space-between align-center"},Fe=oe({__name:"HPPBreakdownDialog",props:{modelValue:{type:Boolean},productId:{},productName:{default:""}},emits:["update:modelValue","hpp-updated","price-updated"],setup(f,{emit:E}){const v=f,$=E,{loading:H,currentHPPBreakdown:i,hasHPPData:S,getProductHPPBreakdown:Q,updateProductHPP:G,updatePriceFromHPP:J,formatCurrency:w}=Pe(),V=h("latest"),j=h(0),m=h(0),N=h(0),B=h(!1),D=h(!1),L=h(""),R=h(""),O=[{title:"Current Cost",value:"current"},{title:"Latest Purchase",value:"latest"},{title:"Average Purchase",value:"average"}],d=[{title:"Item",value:"item_name",sortable:!0},{title:"Quantity",value:"quantity_needed",align:"end"},{title:"Cost/Unit",value:"cost_per_unit",align:"end"},{title:"Total Cost",value:"total_cost",align:"end"},{title:"Priority",value:"is_critical",align:"center"},{title:"Notes",value:"notes"}],l=async()=>{var c,e;if(v.productId)try{const o=localStorage.getItem("token"),p=await T.get(`/api/products/${v.productId}`,{headers:{Authorization:`Bearer ${o}`,Accept:"application/json"}});if(p.data.success&&p.data.data){const F=p.data.data;F.price&&F.price>0?m.value=Number(F.price):(c=i.value)!=null&&c.total_hpp&&(m.value=Math.round(i.value.total_hpp*1.2)),N.value+=1}}catch(o){console.warn("Could not load target price, using default:",o),(e=i.value)!=null&&e.total_hpp&&(m.value=Math.round(i.value.total_hpp*1.2))}},r=async()=>{v.productId&&(await Q(v.productId,V.value),await l())},k=async()=>{var c,e;if(v.productId)try{await G(v.productId,V.value),L.value=`HPP successfully updated using ${V.value} method!`,B.value=!0,$("hpp-updated"),await r()}catch(o){console.error("Error updating HPP:",o),R.value=((e=(c=o==null?void 0:o.response)==null?void 0:c.data)==null?void 0:e.message)||"Failed to update HPP",D.value=!0}},_=async()=>{var c,e,o,p,F,Z;if(v.productId&&((c=i.value)!=null&&c.total_hpp)&&m.value)try{const g=await J(v.productId,V.value,m.value,!0,!0);if((e=g==null?void 0:g.data)!=null&&e.new_price){if(m.value=g.data.new_price,((o=g==null?void 0:g.data)==null?void 0:o.markup_percentage)!==void 0)j.value=g.data.markup_percentage;else{const W=i.value.total_hpp;j.value=W>0?(g.data.new_price-W)/W*100:0}N.value+=1,await re()}await r(),L.value=`Price successfully updated to ${w(((p=g==null?void 0:g.data)==null?void 0:p.new_price)||m.value)}!`,B.value=!0,$("price-updated")}catch(g){console.error("Error applying price suggestion:",g),R.value=((Z=(F=g==null?void 0:g.response)==null?void 0:F.data)==null?void 0:Z.message)||"Failed to update product price",D.value=!0}};return ee(()=>v.modelValue,c=>{c&&v.productId&&r()}),ee(()=>v.productId,c=>{c&&v.modelValue&&r()}),(c,e)=>(y(),X(le,null,[a(ie,{"model-value":c.modelValue,"max-width":"1200",scrollable:"","onUpdate:modelValue":e[4]||(e[4]=o=>c.$emit("update:modelValue",o))},{default:t(()=>[a(U,null,{default:t(()=>[a(Y,{class:"d-flex align-center justify-space-between"},{default:t(()=>[n("div",_e,[a(A,{icon:"mdi-calculator-variant",size:"24"}),n("span",null,"HPP Breakdown - "+u(c.productName||"Product"),1)]),a(I,{icon:"mdi-close",size:"small",variant:"text",onClick:e[0]||(e[0]=o=>c.$emit("update:modelValue",!1))})]),_:1}),a(M,null,{default:t(()=>[a(z,{class:"mb-4"},{default:t(()=>[a(b,{cols:"12",md:"6"},{default:t(()=>[a(ue,{modelValue:V.value,"onUpdate:modelValue":[e[1]||(e[1]=o=>V.value=o),r],items:O,label:"HPP Calculation Method",variant:"outlined"},null,8,["modelValue"])]),_:1}),a(b,{cols:"12",md:"6"},{default:t(()=>[a(I,{color:"primary",variant:"elevated",loading:s(H),"prepend-icon":"mdi-update",block:"",onClick:k},{default:t(()=>[P(" Update HPP with "+u(V.value),1)]),_:1},8,["loading"])]),_:1})]),_:1}),s(S)?(y(),x(U,{key:0,variant:"tonal",color:"primary",class:"mb-4"},{default:t(()=>[a(M,null,{default:t(()=>[a(z,{align:"center"},{default:t(()=>[a(b,{cols:"12",md:"4"},{default:t(()=>[e[9]||(e[9]=n("div",{class:"text-subtitle-2"}," Total HPP ",-1)),n("div",he,u(s(w)(s(i).total_hpp)),1)]),_:1,__:[9]}),a(b,{cols:"12",md:"4"},{default:t(()=>{var o;return[e[10]||(e[10]=n("div",{class:"text-subtitle-2"}," Calculation Method ",-1)),n("div",ye,u((o=O.find(p=>p.value===s(i).method))==null?void 0:o.title),1)]}),_:1,__:[10]}),a(b,{cols:"12",md:"4"},{default:t(()=>[e[11]||(e[11]=n("div",{class:"text-subtitle-2"}," Last Calculated ",-1)),n("div",we,u(new Date(s(i).calculated_at).toLocaleString()),1)]),_:1,__:[11]})]),_:1})]),_:1})]),_:1})):C("",!0),s(S)?(y(),x(U,{key:1},{default:t(()=>[a(Y,null,{default:t(()=>[a(A,{icon:"mdi-format-list-bulleted",class:"me-2"}),P(" Item Breakdown ("+u(s(i).items.length)+" items) ",1)]),_:1}),a(ce,{headers:d,items:s(i).items,"items-per-page":10,class:"elevation-0"},{"item.item_name":t(({item:o})=>[n("div",ke,[n("span",be,u(o.item_name),1),n("span",Ve,u(o.item_code),1)])]),"item.quantity_needed":t(({item:o})=>[n("span",He,u(o.quantity_needed)+" "+u(o.unit),1)]),"item.cost_per_unit":t(({item:o})=>[n("span",null,u(s(w)(o.cost_per_unit)),1)]),"item.total_cost":t(({item:o})=>[a(K,{color:o.is_critical?"error":"primary",variant:"elevated",size:"small"},{default:t(()=>[P(u(s(w)(o.total_cost)),1)]),_:2},1032,["color"])]),"item.is_critical":t(({item:o})=>[a(K,{color:o.is_critical?"error":"success","prepend-icon":o.is_critical?"mdi-alert":"mdi-check",variant:"tonal",size:"small"},{default:t(()=>[P(u(o.is_critical?"Critical":"Normal"),1)]),_:2},1032,["color","prepend-icon"])]),"item.notes":t(({item:o})=>[o.notes?(y(),X("span",xe,u(o.notes),1)):(y(),X("span",Ce,"—"))]),bottom:t(()=>[n("div",$e,[a(pe),n("div",Se,[n("div",Be," Total HPP: "+u(s(w)(s(i).total_hpp)),1),a(K,{color:"info",variant:"elevated"},{default:t(()=>[P(u(s(i).items.length)+" items ",1)]),_:1})])])]),_:1},8,["items"])]),_:1})):C("",!0),s(S)?(y(),x(z,{key:2,class:"mt-4"},{default:t(()=>[a(b,{cols:"12"},{default:t(()=>[a(U,null,{default:t(()=>[a(Y,null,{default:t(()=>[a(A,{icon:"mdi-currency-usd",class:"me-2"}),e[12]||(e[12]=P(" Price Suggestion "))]),_:1,__:[12]}),a(M,null,{default:t(()=>{var o;return[a(z,{align:"end"},{default:t(()=>[a(b,{cols:"12",md:"3"},{default:t(()=>[(y(),x(me,{key:N.value,modelValue:m.value,"onUpdate:modelValue":e[2]||(e[2]=p=>m.value=p),modelModifiers:{number:!0},type:"number",label:"Target Selling Price",variant:"outlined",min:"0",step:"100",prefix:"Rp",hint:"Enter desired selling price","persistent-hint":""},null,8,["modelValue"]))]),_:1}),a(b,{cols:"12",md:"3"},{default:t(()=>{var p;return[m.value&&((p=s(i))!=null&&p.total_hpp)?(y(),x(I,{key:0,color:"success",variant:"elevated",loading:s(H),"prepend-icon":"mdi-check",block:"",onClick:_},{default:t(()=>e[13]||(e[13]=[P(" Apply Price ")])),_:1,__:[13]},8,["loading"])):C("",!0)]}),_:1}),a(b,{cols:"12",md:"3"},{default:t(()=>{var p;return[m.value&&((p=s(i))!=null&&p.total_hpp)?(y(),X("div",De,[e[14]||(e[14]=n("div",{class:"text-subtitle-2"}," Target Price ",-1)),n("div",Ie,u(s(w)(m.value)),1),n("div",Te," Margin: "+u(((m.value-s(i).total_hpp)/s(i).total_hpp*100).toFixed(1))+"% ",1)])):C("",!0)]}),_:1})]),_:1}),m.value&&((o=s(i))!=null&&o.total_hpp)?(y(),x(z,{key:0,class:"mt-4"},{default:t(()=>[a(b,{cols:"12"},{default:t(()=>[a(fe,{color:"info",variant:"tonal",class:"mb-0"},{default:t(()=>[n("div",Ee,[n("div",null,[e[15]||(e[15]=n("strong",null,"HPP:",-1)),P(" "+u(s(w)(s(i).total_hpp))+" | ",1),e[16]||(e[16]=n("strong",null,"Target Price:",-1)),P(" "+u(s(w)(m.value))+" | ",1),e[17]||(e[17]=n("strong",null,"Profit:",-1)),P(" "+u(s(w)(m.value-s(i).total_hpp)),1)]),a(K,{color:"success",variant:"elevated",size:"small"},{default:t(()=>[P(u(((m.value-s(i).total_hpp)/s(i).total_hpp*100).toFixed(1))+"% margin ",1)]),_:1})])]),_:1})]),_:1})]),_:1})):C("",!0)]}),_:1})]),_:1})]),_:1})]),_:1})):C("",!0),s(H)&&!s(S)?(y(),x(U,{key:3},{default:t(()=>[a(M,{class:"text-center py-12"},{default:t(()=>[a(se,{indeterminate:"",size:"64"}),e[18]||(e[18]=n("div",{class:"mt-4 text-h6"}," Loading HPP breakdown... ",-1))]),_:1,__:[18]})]),_:1})):C("",!0),!s(H)&&!s(S)?(y(),x(U,{key:4},{default:t(()=>[a(M,{class:"text-center py-12"},{default:t(()=>[a(A,{icon:"mdi-calculator-variant",size:"64",class:"text-grey-lighten-1 mb-4"}),e[20]||(e[20]=n("div",{class:"text-h6 text-grey-darken-1 mb-2"}," No HPP Data Available ",-1)),e[21]||(e[21]=n("div",{class:"text-body-2 text-grey-darken-1 mb-4"}," This product doesn't have item composition data or HPP calculation failed ",-1)),a(I,{color:"primary",variant:"elevated","prepend-icon":"mdi-refresh",onClick:r},{default:t(()=>e[19]||(e[19]=[P(" Try Again ")])),_:1,__:[19]})]),_:1,__:[20,21]})]),_:1})):C("",!0)]),_:1}),a(de,{class:"px-6 pb-6"},{default:t(()=>[a(ve),a(I,{color:"grey-darken-1",variant:"text",onClick:e[3]||(e[3]=o=>c.$emit("update:modelValue",!1))},{default:t(()=>e[22]||(e[22]=[P(" Close ")])),_:1,__:[22]})]),_:1})]),_:1})]),_:1},8,["model-value"]),a(te,{modelValue:B.value,"onUpdate:modelValue":e[6]||(e[6]=o=>B.value=o),color:"success",location:"top",timeout:4e3},{actions:t(()=>[a(I,{color:"white",variant:"text",onClick:e[5]||(e[5]=o=>B.value=!1)},{default:t(()=>[a(A,null,{default:t(()=>e[23]||(e[23]=[P("mdi-close")])),_:1,__:[23]})]),_:1})]),default:t(()=>[P(u(L.value)+" ",1)]),_:1},8,["modelValue"]),a(te,{modelValue:D.value,"onUpdate:modelValue":e[8]||(e[8]=o=>D.value=o),color:"error",location:"top",timeout:6e3},{actions:t(()=>[a(I,{color:"white",variant:"text",onClick:e[7]||(e[7]=o=>D.value=!1)},{default:t(()=>[a(A,null,{default:t(()=>e[24]||(e[24]=[P("mdi-close")])),_:1,__:[24]})]),_:1})]),default:t(()=>[P(u(R.value)+" ",1)]),_:1},8,["modelValue"])],64))}}),We=ge(Fe,[["__scopeId","data-v-4ce05712"]]);export{We as H,Pe as u};
