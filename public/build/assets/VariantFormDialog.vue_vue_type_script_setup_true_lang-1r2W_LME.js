import{d as Q,r as C,V as g,aw as W,w as h,g as v,f as i,o as u,b as l,e as d,X as S,t as F,a0 as N,$ as Y,l as y,s as D,c as U,F as aa,i as ta,av as A,b8 as ea}from"./main-BDjA8ZE0.js";import{V as oa}from"./VDialog-kKqt15qI.js";import{V as ra,b as la,c as ia}from"./VCard-Af9i-cHC.js";import{V as $}from"./VDivider-CNJRCtTw.js";import{V as sa}from"./VCardText-pusdEz6_.js";import{V as da}from"./VForm-D-6FADkt.js";import{V as z,a as m}from"./VRow-B_tm1uSD.js";import{V as K}from"./VAlert-BUxPj0YW.js";import{V as L}from"./VTextField-BQMuFhOa.js";import{V as na}from"./VSwitch-DvQ6AnPY.js";import{V as ua}from"./VSelect-CqUH4kv5.js";import{V as ca}from"./VSpacer-P6zft6lJ.js";const pa={class:"d-flex align-center gap-2"},ma={class:"d-flex align-center"},va={key:0},fa={key:1,class:"text-warning"},ga={class:"d-flex align-center"},Sa=Q({__name:"VariantFormDialog",props:{modelValue:{type:Boolean},variant:{},products:{},productId:{}},emits:["update:modelValue","save"],setup(R,{emit:G}){const o=R,j=G,f=C(!1),I=C(),p=C([]),V=(r,t="success")=>{console.log(`${t.toUpperCase()}: ${r}`)},k=g({get:()=>o.modelValue,set:r=>j("update:modelValue",r)}),n=g(()=>{var r;return!!((r=o.variant)!=null&&r.id)});g(()=>o.products.map(r=>({title:r.name,value:r.id})));const P=()=>({product_id:0,name:"",sku:"",price:0,current_stock:0,min_stock:0,is_active:!0,description:"",variant_values:[],attributes:{}}),a=W(P()),Z=g(()=>{var r;return a.product_id&&o.products&&o.products.length>0?o.products.find(t=>t.id===a.product_id||t.id_product===a.product_id||t.product_id===a.product_id):((r=o.products)==null?void 0:r[0])||null}),X=g(()=>{const r=Z.value;return r?r.name||r.product_name||"Produk tanpa nama":"Produk tidak dipilih"}),q=()=>{var r;Object.assign(a,P()),p.value=[],(r=I.value)==null||r.resetValidation()},B=()=>{var r;if(console.log("LoadFormData called - Props:",{variant:o.variant,productId:o.productId,products:((r=o.products)==null?void 0:r.length)||0,productsData:o.products}),o.variant)Object.assign(a,{...o.variant,attributes:o.variant.attributes||{}}),a.product_id&&T(a.product_id),console.log("âœ… Edit mode - FormData loaded:",a);else{q();let t=null;if(o.productId)t=o.productId,console.log("âœ… Got product ID from productId prop:",t);else if(o.products&&o.products.length>0){const e=o.products[0];t=e.id||e.id_product||e.product_id,console.log("âœ… Got product ID from products array:",t,"from product:",e)}t?a.product_id=t:(console.error("âŒ No valid product ID found in props!"),console.log("ProductId prop:",o.productId),console.log("Products array:",o.products)),a.product_id&&_(),console.log("âœ… Create mode - FormData initialized:",a)}console.log("FormData after load:",a)},_=()=>{var r;if(a.name&&a.product_id){const t=o.products.find(e=>e.id===a.product_id);if(t){const e=t.code||((r=t.name)==null?void 0:r.substring(0,3).toUpperCase())||"PRD",c=a.name.replace(/[^a-zA-Z0-9]/g,"").substring(0,8).toUpperCase(),s=Date.now().toString().slice(-4);a.sku=`${e}-${c}-${s}`}}else if(a.name){const t=a.name.replace(/[^a-zA-Z0-9]/g,"").substring(0,8).toUpperCase(),e=Date.now().toString().slice(-4);a.sku=`VAR-${t}-${e}`}else a.sku=""},T=async r=>{try{const t=await A.get(`/api/variant-attributes/product/${r}`);p.value=t.data.map(e=>({id:e.id,name:e.name,values:e.values||[]}))}catch(t){console.error("Error loading product attributes:",t),p.value=[]}},O=async()=>{var e,c;const{valid:r}=await I.value.validate();if(!r)return;console.log("FormData before save:",a),console.log("Product ID:",a.product_id),console.log("Props productId:",o.productId),console.log("Props products:",o.products);let t=a.product_id;if(!t&&o.productId&&(t=o.productId),!t&&o.products&&o.products.length>0){const s=o.products[0];console.log("ðŸ” First product from array:",s),t=s.id||s.id_product||s.product_id}if(console.log("ðŸŽ¯ Final resolved productId:",t),!t){V("âŒ Product tidak valid. Dialog akan ditutup. Silakan buka ulang dari halaman produk yang benar.","error"),console.error("No valid product ID found:",{formDataProductId:a.product_id,propsProductId:o.productId,products:o.products,props:o}),setTimeout(()=>{k.value=!1},2e3);return}a.product_id=t,f.value=!0;try{const s={};a.attributes&&Object.keys(a.attributes).length>0?Object.entries(a.attributes).forEach(([x,E])=>{const M=p.value.find(J=>J.id.toString()===x);M&&E&&(s[M.name]=E)}):s.Variant=a.name;const b={id_product:t,name:a.name,sku:a.sku||"",price:0,variant_values:s,active:a.is_active!==!1};if(console.log("Payload that will be sent:",b),n.value){const x={id_product:t,name:a.name,sku:a.sku,price:a.price||0,variant_values:a.variant_values||s,active:a.is_active,...Object.keys(a.attributes||{}).length>0&&{attributes:a.attributes}};await A.put(`/api/variants/${a.id}`,x),V("Variant berhasil diupdate")}else await A.post("/api/variants",b),V("Variant berhasil ditambahkan! Sekarang Anda dapat menambahkan item untuk variant ini.");j("save"),w()}catch(s){const b=((c=(e=s.response)==null?void 0:e.data)==null?void 0:c.message)||"Terjadi kesalahan";V(b,"error")}finally{f.value=!1}},w=()=>{k.value=!1,ea(()=>{H()})},H=()=>{Object.assign(a,P()),p.value=[]};return h(()=>o.modelValue,r=>{r&&B()}),h(()=>o.variant,()=>{o.modelValue&&B()}),h(()=>a.product_id,r=>{r&&!n.value&&(T(r),_(),a.attributes={})}),h(()=>a.name,()=>{n.value||_()}),(r,t)=>(u(),v(oa,{modelValue:k.value,"onUpdate:modelValue":t[3]||(t[3]=e=>k.value=e),"max-width":"800px",persistent:""},{default:i(()=>[l(ra,null,{default:i(()=>[l(la,{class:"d-flex align-center justify-space-between"},{default:i(()=>[d("div",pa,[l(S,{icon:n.value?"mdi-pencil":"mdi-plus"},null,8,["icon"]),d("span",null,F(n.value?"Edit Variant":"Tambah Variant Baru"),1)]),l(N,{icon:"mdi-close",variant:"text",onClick:w,disabled:f.value},null,8,["disabled"])]),_:1}),l($),l(sa,{class:"pt-4"},{default:i(()=>[l(da,{ref_key:"form",ref:I,onSubmit:Y(O,["prevent"])},{default:i(()=>[l(z,null,{default:i(()=>[n.value?y("",!0):(u(),v(m,{key:0,cols:"12"},{default:i(()=>[l(K,{type:a.product_id?"info":"warning",variant:"tonal",class:"mb-4"},{default:i(()=>[d("div",ma,[l(S,{icon:"mdi-package",class:"me-2"}),d("div",null,[t[4]||(t[4]=d("strong",null,"Produk:",-1)),D(" "+F(X.value||"Produk tidak terdeteksi")+" ",1),t[5]||(t[5]=d("br",null,null,-1)),a.product_id?(u(),U("small",va,"Variant akan dibuat untuk produk ini")):(u(),U("small",fa,"âš ï¸ Silakan pastikan produk dipilih dengan benar"))])])]),_:1},8,["type"])]),_:1})),l(m,{cols:"12"},{default:i(()=>[l(L,{modelValue:a.name,"onUpdate:modelValue":t[0]||(t[0]=e=>a.name=e),label:"Nama Variant *",variant:"outlined",rules:[e=>!!e||"Nama variant harus diisi",e=>e&&e.length>=3||"Nama variant minimal 3 karakter"],onInput:_,hint:"Contoh: Mangga Manis, Mangga Asam, dll","persistent-hint":"",placeholder:"Masukkan nama variant..."},null,8,["modelValue","rules"])]),_:1}),a.sku?(u(),v(m,{key:1,cols:"12"},{default:i(()=>[l(L,{modelValue:a.sku,"onUpdate:modelValue":t[1]||(t[1]=e=>a.sku=e),label:"SKU (Otomatis)",variant:"outlined",readonly:"",hint:"SKU dibuat otomatis berdasarkan nama variant","persistent-hint":"","prepend-inner-icon":"mdi-auto-fix"},null,8,["modelValue"])]),_:1})):y("",!0),l(m,{cols:"12"},{default:i(()=>[l(na,{modelValue:a.is_active,"onUpdate:modelValue":t[2]||(t[2]=e=>a.is_active=e),label:"Aktif",color:"success","hide-details":""},null,8,["modelValue"])]),_:1}),n.value?y("",!0):(u(),v(m,{key:2,cols:"12"},{default:i(()=>[l(K,{type:"success",variant:"tonal"},{default:i(()=>[d("div",ga,[l(S,{icon:"mdi-lightbulb-on",class:"me-2"}),t[6]||(t[6]=d("div",null,[d("strong",null,"Langkah selanjutnya:"),D(' Setelah variant dibuat, Anda dapat menambahkan item/bahan untuk variant ini melalui tombol "Kelola Item". ')],-1))])]),_:1})]),_:1})),p.value.length>0?(u(),v(m,{key:3,cols:"12"},{default:i(()=>[l($,{class:"mb-4"}),t[7]||(t[7]=d("h3",{class:"text-h6 mb-4"},"Atribut Variant",-1)),l(z,null,{default:i(()=>[(u(!0),U(aa,null,ta(p.value,e=>(u(),v(m,{key:e.id,cols:"12",md:"6"},{default:i(()=>[l(ua,{modelValue:a.attributes[e.id],"onUpdate:modelValue":c=>a.attributes[e.id]=c,items:e.values,label:`${e.name} *`,variant:"outlined",rules:[c=>!!c||`${e.name} harus dipilih`]},null,8,["modelValue","onUpdate:modelValue","items","label","rules"])]),_:2},1024))),128))]),_:1})]),_:1,__:[7]})):y("",!0)]),_:1})]),_:1},512)]),_:1}),l($),l(ia,null,{default:i(()=>[l(ca),l(N,{variant:"outlined","prepend-icon":"mdi-close",onClick:w,disabled:f.value},{default:i(()=>t[8]||(t[8]=[D(" Batal ")])),_:1,__:[8]},8,["disabled"]),l(N,{color:"primary",variant:"elevated","prepend-icon":n.value?"mdi-check":"mdi-content-save",onClick:O,loading:f.value},{default:i(()=>[D(F(n.value?"Update":"Simpan"),1)]),_:1},8,["prepend-icon","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]))}});export{Sa as _};
