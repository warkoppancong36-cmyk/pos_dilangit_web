import{r as _,V as q,au as F,d as ae,w as ee,c as K,F as oe,b as a,f as t,e as n,X as A,t as d,a1 as D,g as H,l as C,m as l,s as P,at as le,ax as re,av as se,o as y,_ as ne}from"./main-Wp4obA_l.js";import{$ as ie}from"./api-HD4zcl8f.js";import{V as de}from"./VDialog-C9iCstih.js";import{V as te}from"./VSnackbar-DLOYVb-l.js";import{V as z,b as Y,c as ue}from"./VCard-vJ2cJYB9.js";import{V as N}from"./VCardText-BtrOso5w.js";import{V as j,a as b}from"./VRow-n4fmOSfg.js";import{V as ce}from"./VSelect-B3vz8IgG.js";import{V as pe}from"./VDataTable-FxBITjIU.js";import{V as me}from"./VDivider-Bj_Ho8q8.js";import{V as Q}from"./VChip-Bh-aXx5O.js";import{V as ve}from"./VTextField-h6Cw9FIn.js";import{V as fe}from"./VSpacer-C3ZPjIQd.js";const ge=()=>{const v=_(!1),E=_(null),f=_(null),I=_(null),x=_(null),i=_([]),$=async()=>{v.value=!0;try{const r=(await F.get("/api/hpp/dashboard")).data;if(r.success)return x.value=r.data,r.data;throw new Error(r.message||"Failed to get HPP dashboard")}catch(c){throw console.error("Error getting HPP dashboard:",c),c}finally{v.value=!1}},X=async(c,r="current")=>{v.value=!0;try{const k=(await F.get(`/api/hpp/products/${c}/breakdown?method=${r}`)).data;if(k.success)return E.value=k.data.hpp_breakdown,k.data;throw new Error(k.message||"Failed to get HPP breakdown")}catch(s){throw console.error("❌ Error getting HPP breakdown:",s),s}finally{v.value=!1}},G=async(c,r)=>{v.value=!0;try{const s=localStorage.getItem("token"),h=(await F.post(`/api/hpp/products/${c}/update`,{method:r},{headers:{Authorization:`Bearer ${s}`,Accept:"application/json","Content-Type":"application/json"}})).data;if(h.success)return h.data;throw new Error(h.message||"Failed to update HPP")}catch(s){throw console.error("❌ Error updating HPP:",s),s}finally{v.value=!1}},J=async c=>{v.value=!0;try{const s=(await F.get(`/api/hpp/products/${c}/compare-methods`)).data;if(s.success)return f.value=s.data,s.data;throw new Error(s.message||"Failed to compare HPP methods")}catch(r){throw console.error("Error comparing HPP methods:",r),r}finally{v.value=!1}},w=async(c,r)=>{v.value=!0;try{const s=localStorage.getItem("token"),h=(await F.post(`/api/hpp/products/${c}/suggested-price`,{markup_percentage:r},{headers:{Authorization:`Bearer ${s}`,Accept:"application/json","Content-Type":"application/json"}})).data;if(h.success)return I.value=h.data,h.data;throw new Error(h.message||"Failed to calculate suggested price")}catch(s){throw console.error("❌ Error calculating suggested price:",s),s}finally{v.value=!1}},V=async(c,r,s,k=!0,h=!1)=>{v.value=!0;try{const u=localStorage.getItem("token"),e={method:r,update_cost:k};h?e.target_price=s:e.markup_percentage=s;const p=(await F.post(`/api/hpp/products/${c}/update-price`,e,{headers:{Authorization:`Bearer ${u}`,Accept:"application/json","Content-Type":"application/json"}})).data;if(p.success)return p;throw new Error(p.message||"Failed to update price from HPP")}catch(u){throw console.error("❌ Error updating price from HPP:",u),u}finally{v.value=!1}},U=async c=>{v.value=!0;try{const r=await ie("/hpp/bulk-update",{method:"POST",body:{method:c}});if(r.success)return i.value=r.data.details,r.data;throw new Error(r.message||"Failed to bulk update HPP")}catch(r){throw console.error("Error bulk updating HPP:",r),r}finally{v.value=!1}},m=q(()=>E.value!==null),M=q(()=>f.value!==null),S=q(()=>I.value!==null),B=q(()=>x.value!==null);return{loading:v,currentHPPBreakdown:E,currentHPPComparison:f,currentHPPSuggestion:I,hppDashboard:x,bulkUpdateResults:i,getHPPDashboard:$,getProductHPPBreakdown:X,updateProductHPP:G,compareHPPMethods:J,calculateSuggestedPrice:w,updatePriceFromHPP:V,bulkUpdateHPP:U,hasHPPData:m,hasComparisonData:M,hasSuggestionData:S,hasDashboardData:B,formatCurrency:c=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(c),calculateProfitPercentage:(c,r)=>r===0?0:(c-r)/r*100,resetStates:()=>{E.value=null,f.value=null,I.value=null,i.value=[]}}},Pe={class:"d-flex align-center gap-3"},_e={class:"text-h5 font-weight-bold"},he={class:"text-h6"},ye={class:"text-body-1"},we={class:"d-flex flex-column"},ke={class:"font-weight-medium"},be={class:"text-caption text-grey-darken-1"},Ve={class:"font-weight-medium"},xe={key:0,class:"text-caption"},He={key:1,class:"text-grey-lighten-1 text-caption"},Ce={class:"v-data-table__footer"},Ie={class:"pa-4 d-flex justify-space-between align-center"},$e={class:"text-subtitle-1 font-weight-bold"},Se={key:0,class:"text-center"},Be={class:"text-h6 font-weight-bold text-success"},De={class:"text-caption text-grey-darken-1"},Fe={class:"d-flex justify-space-between align-center"},Ee=ae({__name:"HPPBreakdownDialog",props:{modelValue:{type:Boolean},productId:{},productName:{default:""}},emits:["update:modelValue","hpp-updated","price-updated"],setup(v,{emit:E}){const f=v,I=E,{loading:x,currentHPPBreakdown:i,hasHPPData:$,getProductHPPBreakdown:X,updateProductHPP:G,updatePriceFromHPP:J,formatCurrency:w}=ge(),V=_("latest"),U=_(0),m=_(0),M=_(0),S=_(!1),B=_(!1),L=_(""),R=_(""),O=[{title:"Current Cost",value:"current"},{title:"Latest Purchase",value:"latest"},{title:"Average Purchase",value:"average"}],c=[{title:"Item",value:"item_name",sortable:!0},{title:"Quantity",value:"quantity_needed",align:"end"},{title:"Cost/Unit",value:"cost_per_unit",align:"end"},{title:"Total Cost",value:"total_cost",align:"end"},{title:"Priority",value:"is_critical",align:"center"},{title:"Notes",value:"notes"}],r=async()=>{var u,e;if(f.productId)try{const o=localStorage.getItem("token"),p=await F.get(`/api/products/${f.productId}`,{headers:{Authorization:`Bearer ${o}`,Accept:"application/json"}});if(p.data.success&&p.data.data){const T=p.data.data;T.price&&T.price>0?m.value=Number(T.price):(u=i.value)!=null&&u.total_hpp&&(m.value=Math.round(i.value.total_hpp*1.2)),M.value+=1}}catch(o){console.warn("Could not load target price, using default:",o),(e=i.value)!=null&&e.total_hpp&&(m.value=Math.round(i.value.total_hpp*1.2))}},s=async()=>{f.productId&&(await X(f.productId,V.value),await r())},k=async()=>{var u,e;if(f.productId)try{await G(f.productId,V.value),L.value=`HPP successfully updated using ${V.value} method!`,S.value=!0,I("hpp-updated"),await s()}catch(o){console.error("Error updating HPP:",o),R.value=((e=(u=o==null?void 0:o.response)==null?void 0:u.data)==null?void 0:e.message)||"Failed to update HPP",B.value=!0}},h=async()=>{var u,e,o,p,T,Z;if(f.productId&&((u=i.value)!=null&&u.total_hpp)&&m.value)try{const g=await J(f.productId,V.value,m.value,!0,!0);if((e=g==null?void 0:g.data)!=null&&e.new_price){if(m.value=g.data.new_price,((o=g==null?void 0:g.data)==null?void 0:o.markup_percentage)!==void 0)U.value=g.data.markup_percentage;else{const W=i.value.total_hpp;U.value=W>0?(g.data.new_price-W)/W*100:0}M.value+=1,await se()}await s(),L.value=`Price successfully updated to ${w(((p=g==null?void 0:g.data)==null?void 0:p.new_price)||m.value)}!`,S.value=!0,I("price-updated")}catch(g){console.error("Error applying price suggestion:",g),R.value=((Z=(T=g==null?void 0:g.response)==null?void 0:T.data)==null?void 0:Z.message)||"Failed to update product price",B.value=!0}};return ee(()=>f.modelValue,u=>{u&&f.productId&&s()}),ee(()=>f.productId,u=>{u&&f.modelValue&&s()}),(u,e)=>(y(),K(oe,null,[a(de,{"model-value":u.modelValue,"max-width":"1200",scrollable:"","onUpdate:modelValue":e[4]||(e[4]=o=>u.$emit("update:modelValue",o))},{default:t(()=>[a(z,null,{default:t(()=>[a(Y,{class:"d-flex align-center justify-space-between"},{default:t(()=>[n("div",Pe,[a(A,{icon:"mdi-calculator-variant",size:"24"}),n("span",null,"HPP Breakdown - "+d(u.productName||"Product"),1)]),a(D,{icon:"mdi-close",size:"small",variant:"text",onClick:e[0]||(e[0]=o=>u.$emit("update:modelValue",!1))})]),_:1}),a(N,null,{default:t(()=>[a(j,{class:"mb-4"},{default:t(()=>[a(b,{cols:"12",md:"6"},{default:t(()=>[a(ce,{modelValue:V.value,"onUpdate:modelValue":[e[1]||(e[1]=o=>V.value=o),s],items:O,label:"HPP Calculation Method",variant:"outlined"},null,8,["modelValue"])]),_:1}),a(b,{cols:"12",md:"6"},{default:t(()=>[a(D,{color:"primary",variant:"elevated",loading:l(x),"prepend-icon":"mdi-update",block:"",onClick:k},{default:t(()=>[P(" Update HPP with "+d(V.value),1)]),_:1},8,["loading"])]),_:1})]),_:1}),l($)?(y(),H(z,{key:0,variant:"tonal",color:"primary",class:"mb-4"},{default:t(()=>[a(N,null,{default:t(()=>[a(j,{align:"center"},{default:t(()=>[a(b,{cols:"12",md:"4"},{default:t(()=>[e[9]||(e[9]=n("div",{class:"text-subtitle-2"}," Total HPP ",-1)),n("div",_e,d(l(w)(l(i).total_hpp)),1)]),_:1,__:[9]}),a(b,{cols:"12",md:"4"},{default:t(()=>{var o;return[e[10]||(e[10]=n("div",{class:"text-subtitle-2"}," Calculation Method ",-1)),n("div",he,d((o=O.find(p=>p.value===l(i).method))==null?void 0:o.title),1)]}),_:1,__:[10]}),a(b,{cols:"12",md:"4"},{default:t(()=>[e[11]||(e[11]=n("div",{class:"text-subtitle-2"}," Last Calculated ",-1)),n("div",ye,d(new Date(l(i).calculated_at).toLocaleString()),1)]),_:1,__:[11]})]),_:1})]),_:1})]),_:1})):C("",!0),l($)?(y(),H(z,{key:1},{default:t(()=>[a(Y,null,{default:t(()=>[a(A,{icon:"mdi-format-list-bulleted",class:"me-2"}),P(" Item Breakdown ("+d(l(i).items.length)+" items) ",1)]),_:1}),a(pe,{headers:c,items:l(i).items,"items-per-page":10,class:"elevation-0"},{"item.item_name":t(({item:o})=>[n("div",we,[n("span",ke,d(o.item_name),1),n("span",be,d(o.item_code),1)])]),"item.quantity_needed":t(({item:o})=>[n("span",Ve,d(parseFloat(o.quantity_needed))+" "+d(o.unit),1)]),"item.cost_per_unit":t(({item:o})=>[n("span",null,d(l(w)(o.cost_per_unit)),1)]),"item.total_cost":t(({item:o})=>[a(Q,{color:o.is_critical?"error":"primary",variant:"elevated",size:"small"},{default:t(()=>[P(d(l(w)(o.total_cost)),1)]),_:2},1032,["color"])]),"item.is_critical":t(({item:o})=>[a(Q,{color:o.is_critical?"error":"success","prepend-icon":o.is_critical?"mdi-alert":"mdi-check",variant:"tonal",size:"small"},{default:t(()=>[P(d(o.is_critical?"Critical":"Normal"),1)]),_:2},1032,["color","prepend-icon"])]),"item.notes":t(({item:o})=>[o.notes?(y(),K("span",xe,d(o.notes),1)):(y(),K("span",He,"—"))]),bottom:t(()=>[n("div",Ce,[a(me),n("div",Ie,[n("div",$e," Total HPP: "+d(l(w)(l(i).total_hpp)),1),a(Q,{color:"info",variant:"elevated"},{default:t(()=>[P(d(l(i).items.length)+" items ",1)]),_:1})])])]),_:1},8,["items"])]),_:1})):C("",!0),l($)?(y(),H(j,{key:2,class:"mt-4"},{default:t(()=>[a(b,{cols:"12"},{default:t(()=>[a(z,null,{default:t(()=>[a(Y,null,{default:t(()=>[a(A,{icon:"mdi-currency-usd",class:"me-2"}),e[12]||(e[12]=P(" Price Suggestion "))]),_:1,__:[12]}),a(N,null,{default:t(()=>{var o;return[a(j,{align:"end"},{default:t(()=>[a(b,{cols:"12",md:"3"},{default:t(()=>[(y(),H(ve,{key:M.value,modelValue:m.value,"onUpdate:modelValue":e[2]||(e[2]=p=>m.value=p),modelModifiers:{number:!0},type:"number",label:"Target Selling Price",variant:"outlined",min:"0",step:"100",prefix:"Rp",hint:"Enter desired selling price","persistent-hint":""},null,8,["modelValue"]))]),_:1}),a(b,{cols:"12",md:"3"},{default:t(()=>{var p;return[m.value&&((p=l(i))!=null&&p.total_hpp)?(y(),H(D,{key:0,color:"success",variant:"elevated",loading:l(x),"prepend-icon":"mdi-check",block:"",onClick:h},{default:t(()=>e[13]||(e[13]=[P(" Apply Price ")])),_:1,__:[13]},8,["loading"])):C("",!0)]}),_:1}),a(b,{cols:"12",md:"3"},{default:t(()=>{var p;return[m.value&&((p=l(i))!=null&&p.total_hpp)?(y(),K("div",Se,[e[14]||(e[14]=n("div",{class:"text-subtitle-2"}," Target Price ",-1)),n("div",Be,d(l(w)(m.value)),1),n("div",De," Margin: "+d(((m.value-l(i).total_hpp)/l(i).total_hpp*100).toFixed(1))+"% ",1)])):C("",!0)]}),_:1})]),_:1}),m.value&&((o=l(i))!=null&&o.total_hpp)?(y(),H(j,{key:0,class:"mt-4"},{default:t(()=>[a(b,{cols:"12"},{default:t(()=>[a(le,{color:"info",variant:"tonal",class:"mb-0"},{default:t(()=>[n("div",Fe,[n("div",null,[e[15]||(e[15]=n("strong",null,"HPP:",-1)),P(" "+d(l(w)(l(i).total_hpp))+" | ",1),e[16]||(e[16]=n("strong",null,"Target Price:",-1)),P(" "+d(l(w)(m.value))+" | ",1),e[17]||(e[17]=n("strong",null,"Profit:",-1)),P(" "+d(l(w)(m.value-l(i).total_hpp)),1)]),a(Q,{color:"success",variant:"elevated",size:"small"},{default:t(()=>[P(d(((m.value-l(i).total_hpp)/l(i).total_hpp*100).toFixed(1))+"% margin ",1)]),_:1})])]),_:1})]),_:1})]),_:1})):C("",!0)]}),_:1})]),_:1})]),_:1})]),_:1})):C("",!0),l(x)&&!l($)?(y(),H(z,{key:3},{default:t(()=>[a(N,{class:"text-center py-12"},{default:t(()=>[a(re,{indeterminate:"",size:"64"}),e[18]||(e[18]=n("div",{class:"mt-4 text-h6"}," Loading HPP breakdown... ",-1))]),_:1,__:[18]})]),_:1})):C("",!0),!l(x)&&!l($)?(y(),H(z,{key:4},{default:t(()=>[a(N,{class:"text-center py-12"},{default:t(()=>[a(A,{icon:"mdi-calculator-variant",size:"64",class:"text-grey-lighten-1 mb-4"}),e[20]||(e[20]=n("div",{class:"text-h6 text-grey-darken-1 mb-2"}," No HPP Data Available ",-1)),e[21]||(e[21]=n("div",{class:"text-body-2 text-grey-darken-1 mb-4"}," This product doesn't have item composition data or HPP calculation failed ",-1)),a(D,{color:"primary",variant:"elevated","prepend-icon":"mdi-refresh",onClick:s},{default:t(()=>e[19]||(e[19]=[P(" Try Again ")])),_:1,__:[19]})]),_:1,__:[20,21]})]),_:1})):C("",!0)]),_:1}),a(ue,{class:"px-6 pb-6"},{default:t(()=>[a(fe),a(D,{color:"grey-darken-1",variant:"text",onClick:e[3]||(e[3]=o=>u.$emit("update:modelValue",!1))},{default:t(()=>e[22]||(e[22]=[P(" Close ")])),_:1,__:[22]})]),_:1})]),_:1})]),_:1},8,["model-value"]),a(te,{modelValue:S.value,"onUpdate:modelValue":e[6]||(e[6]=o=>S.value=o),color:"success",location:"top",timeout:4e3},{actions:t(()=>[a(D,{color:"white",variant:"text",onClick:e[5]||(e[5]=o=>S.value=!1)},{default:t(()=>[a(A,null,{default:t(()=>e[23]||(e[23]=[P("mdi-close")])),_:1,__:[23]})]),_:1})]),default:t(()=>[P(d(L.value)+" ",1)]),_:1},8,["modelValue"]),a(te,{modelValue:B.value,"onUpdate:modelValue":e[8]||(e[8]=o=>B.value=o),color:"error",location:"top",timeout:6e3},{actions:t(()=>[a(D,{color:"white",variant:"text",onClick:e[7]||(e[7]=o=>B.value=!1)},{default:t(()=>[a(A,null,{default:t(()=>e[24]||(e[24]=[P("mdi-close")])),_:1,__:[24]})]),_:1})]),default:t(()=>[P(d(R.value)+" ",1)]),_:1},8,["modelValue"])],64))}}),Ge=ne(Ee,[["__scopeId","data-v-901d725a"]]);export{Ge as H,ge as u};
